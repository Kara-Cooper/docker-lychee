#!/usr/bin/with-contenv bash

cd /app/lychee

# copy config
[[ ! -e /config/user.ini ]] && \
	cp /defaults/user.ini /config/user.ini
cp /config/user.ini /etc/php7/conf.d/99-user.ini

# pre-populate /pictures directory if it's empty
if [ ! "$(ls -A /pictures)" ]; then
	mv /app/lychee/public/uploads/* /pictures/
	chown -R abc:abc /pictures
fi

[[ ! -L "/app/lychee/public/uploads" ]] && rm -rf /app/lychee/public/uploads
ln -sf /pictures /app/lychee/public/uploads

# handle storage directory
[[ ! -e "/config/storage" ]] && \
	mv /app/lychee/storage /config/

rm -rf /app/lychee/storage
ln -s /config/storage /app/lychee/storage
ln -sf /config/.env /app/lychee/.env

# check for .env and copy default if needed
if [ ! -f "/config/.env" ]; then
	cp /app/lychee/.env.example /config/.env

	# attempt upgrade
	if [ -f "/config/lychee/config.php" ]; then
		php /defaults/upgrade.php
		mv /config/lychee /config/lychee.old

		# force nginx config upgrade
		mv /config/nginx/site-confs/default /config/nginx/default.bak
		mv /defaults/default /config/nginx/site-confs/default

		php artisan key:generate
		php artisan migrate
	fi
else
	php artisan migrate
fi

# permissions
chown -R abc:abc \
	/app/lychee \
	/config
